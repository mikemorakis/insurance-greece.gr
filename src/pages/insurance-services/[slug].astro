---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeroQuoteFormSimple from '../../components/forms/HeroQuoteFormSimple';
import QuoteForm from '../../components/forms/QuoteForm';
import FAQAccordion from '../../components/ui/FAQAccordion';
import Picture from '../../components/ui/Picture.astro';
import { SERVICE_TYPES, getServiceDescription } from '../../data/navigation';
import { serviceSpecificFaqs } from '../../data/faqs';
import { serviceContent } from '../../data/service-content';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return SERVICE_TYPES.map((service) => ({
    params: { slug: service.slug },
    props: { service },
  }));
}

const { service } = Astro.props;
const faqs = serviceSpecificFaqs[service.slug] || [];
const content = serviceContent[service.slug];

const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.data.category === service.slug && p.data.status === 'published')
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 2);
---
<BaseLayout
  title={`${service.name} in Greece | Insurance Greece`}
  description={`${getServiceDescription(service.slug)} Get a free quote from Insurance Greece.`}
  canonical={`/insurance-services/${service.slug}/`}
  jsonLd={[
    { '@context': 'https://schema.org', '@type': 'BreadcrumbList', itemListElement: [
      { '@type': 'ListItem', position: 1, name: 'Home', item: 'https://insurance-greece.com/' },
      { '@type': 'ListItem', position: 2, name: 'Insurance Services', item: 'https://insurance-greece.com/insurance-services/' },
      { '@type': 'ListItem', position: 3, name: service.name, item: `https://insurance-greece.com/insurance-services/${service.slug}/` },
    ]},
    ...(faqs.length > 0 ? [{ '@context': 'https://schema.org', '@type': 'FAQPage', mainEntity: faqs.map(faq => ({ '@type': 'Question', name: faq.question, acceptedAnswer: { '@type': 'Answer', text: faq.answer.replace(/<[^>]*>/g, '') } })) }] : []),
  ]}
>
  <!-- Hero Section -->
  <section class="hero" style={`background-image: linear-gradient(rgba(15,23,42,0.7), rgba(30,41,59,0.75)), url('${service.heroImage}');`}>
    <div class="container">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a> / <a href="/insurance-services/">Services</a> / <span>{service.name}</span>
      </nav>
      <h1>{service.name} in Greece</h1>
      <p>Expert {service.name.toLowerCase()} solutions for expats</p>
      <HeroQuoteFormSimple client:visible serviceSlug={service.slug} serviceName={service.name} />
    </div>
  </section>

  <!-- Content Section -->
  <section class="section">
    <div class="container">
      <div class="main-content">
        {content && content.paragraphs.map((p, i) => i === 0 ? <p><strong>{p}</strong></p> : <p>{p}</p>)}

        <div class="how-to-box">
          <h2><svg class="info-icon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="rgba(255,255,255,0.25)"/><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="8" r="1"/></svg> How to Get Started</h2>
          <ol>
            <li><strong><a href="#quote-form">Request a Quote:</a></strong> Fill out our simple form below or contact us directly.</li>
            <li><strong>Compare Options:</strong> We'll present you with the best options from multiple insurers.</li>
            <li><strong>Choose Your Policy:</strong> Select the coverage that best fits your needs and budget.</li>
            <li><strong>Get Covered:</strong> We handle all the paperwork and you receive your policy documents.</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  {faqs.length > 0 && (
    <section class="section section-alt">
      <div class="container">
        <div class="faq-section">
          <div class="section-title">
            <h2>Frequently Asked Questions about {service.name}</h2>
          </div>
          <FAQAccordion client:visible faqs={faqs} />
        </div>
      </div>
    </section>
  )}

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <section class="section section-alt">
      <div class="container">
        <div class="section-title">
          <h2>Useful Tips about {service.name}</h2>
          <p>Read our latest articles related to {service.name.toLowerCase()} in Greece</p>
        </div>
        <div class="posts-grid">
          {relatedPosts.map((post) => (
            <a href={`/${post.slug}/`} class="post-card">
              {post.data.featuredImg && (
                <div class="post-card-img">
                  <img src={post.data.featuredImg} alt={post.data.title} loading="lazy" />
                </div>
              )}
              <div class="post-card-body">
                <h3>{post.data.title}</h3>
                <p>{post.data.excerpt ? post.data.excerpt.slice(0, 100) + '...' : ''}</p>
                <span class="read-more">Read more</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Quote Form Section -->
  <section class="quote-section" id="quote-form">
    <div class="container">
      <div class="quote-form-wrapper">
        <h2>Get Your Free {service.name} Quote</h2>
        <p>Fill in your details and we'll get back to you within 48 hours</p>
        <QuoteForm client:visible serviceSlug={service.slug} serviceName={service.name} />
      </div>
    </div>
  </section>

  <!-- All Services -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-title">
        <h2>Our Insurance Services</h2>
        <p>Comprehensive insurance solutions tailored for expats living in Greece. All services available in English.</p>
      </div>
      <div class="services-grid">
        {SERVICE_TYPES.map((s) => (
          <a href={`/insurance-services/${s.slug}/`} class="service-card">
            <div class="service-image">
              <Picture src={s.image} alt={s.name} width={600} height={338} loading="lazy" />
            </div>
            <div class="service-content">
              <h3>{s.name}</h3>
              <p>Learn more about {s.name.toLowerCase()} options for expats in Greece.</p>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
.hero { background-size: cover; background-position: center; color: var(--white); min-height: 50vh; display: flex; align-items: center; justify-content: center; text-align: center; }
.hero h1 { font-size: var(--font-size-4xl); margin-bottom: var(--spacing-4); color: var(--white); }
.hero p { font-size: var(--font-size-xl); color: var(--gray-300); margin-bottom: var(--spacing-6); }
.breadcrumb { font-size: var(--font-size-sm); margin-bottom: var(--spacing-6); }
.breadcrumb a { color: var(--gray-300); }
.breadcrumb a:hover { color: var(--white); }
.breadcrumb span { color: var(--white); }
.main-content { max-width: 800px; margin: 0 auto; }
.main-content h2 { margin-top: var(--spacing-8); margin-bottom: var(--spacing-4); }
.main-content h2:first-child { margin-top: 0; }
.main-content p { line-height: 1.8; color: var(--color-text-light); }
.main-content ul, .main-content ol { margin: var(--spacing-4) 0; }
.main-content li { margin-bottom: var(--spacing-3); line-height: 1.6; }
.how-to-box { background: var(--brand-orange); color: var(--white); padding: var(--spacing-6) var(--spacing-8); border-radius: var(--radius-xl); margin-top: var(--spacing-8); }
.how-to-box h2 { color: var(--white); margin-top: 0; margin-bottom: var(--spacing-4); display: flex; align-items: center; gap: var(--spacing-3); }
.info-icon { flex-shrink: 0; }
.how-to-box ol { margin: 0; }
.how-to-box li { color: var(--white); margin-bottom: var(--spacing-3); line-height: 1.6; }
.how-to-box li:last-child { margin-bottom: 0; }
.how-to-box a { color: var(--white); text-decoration: underline; text-underline-offset: 2px; }
.how-to-box a:hover { opacity: 0.85; }
.faq-section { max-width: 800px; margin: 0 auto; }
.services-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-6); }
.service-card { display: flex; flex-direction: column; background: var(--white); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); overflow: hidden; transition: transform var(--transition-base), box-shadow var(--transition-base); text-decoration: none; }
.service-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
.service-image { position: relative; width: 100%; height: 180px; overflow: hidden; }
.service-image :global(img) { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
.service-card:hover .service-image :global(img) { transform: scale(1.05); }
.service-content { padding: var(--spacing-5) var(--spacing-4); text-align: center; }
.service-card h3 { font-size: var(--font-size-lg); margin-bottom: var(--spacing-2); color: var(--brand-dark); }
.service-card p { font-size: var(--font-size-sm); color: var(--color-text-light); margin-bottom: 0; }
.quote-section { background: linear-gradient(rgba(15,23,42,0.85), rgba(30,41,59,0.9)), url('/images/services/insurance_0005_Background.jpg') center/cover no-repeat; padding: var(--spacing-16) 0; }
.quote-form-wrapper { max-width: 700px; margin: 0 auto; background: var(--white); padding: var(--spacing-8); border-radius: var(--radius-2xl); box-shadow: var(--shadow-xl); }
.quote-form-wrapper h2 { text-align: center; margin-bottom: var(--spacing-2); }
.quote-form-wrapper > p { text-align: center; color: var(--color-text-light); margin-bottom: var(--spacing-6); }
.posts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-6); }
.post-card { display: flex; flex-direction: column; background: var(--white); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); overflow: hidden; text-decoration: none; transition: transform var(--transition-base), box-shadow var(--transition-base); }
.post-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
.post-card-img { height: 240px; overflow: hidden; }
.post-card-img img { width: 100%; height: 100%; object-fit: cover; }
.post-card-body { padding: var(--spacing-4); }
.post-card-body h3 { font-size: var(--font-size-base); margin-bottom: var(--spacing-2); color: var(--color-text); }
.post-card-body p { font-size: var(--font-size-sm); color: var(--color-text-light); margin-bottom: var(--spacing-3); }
.read-more { font-size: var(--font-size-sm); font-weight: 600; color: var(--brand-orange); }
@media (max-width: 1024px) { .services-grid { grid-template-columns: repeat(2, 1fr); } .posts-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) {
  .hero { min-height: auto; padding: var(--spacing-10) 0; }
  .hero h1 { font-size: var(--font-size-3xl); }
  .hero p { font-size: var(--font-size-base); margin-bottom: var(--spacing-4); }
  .quote-form-wrapper { padding: var(--spacing-6); }
  .services-grid { grid-template-columns: 1fr; }
  .posts-grid { grid-template-columns: 1fr; }
}
</style>
