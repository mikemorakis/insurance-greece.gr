---
interface Props {
  src: string;
  alt: string;
  class?: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  style?: string;
  widths?: number[];
  sizes?: string;
}

const { src, alt, class: className, width, height, loading = 'lazy', fetchpriority, style, widths, sizes } = Astro.props;

// Derive avif/webp paths from the original src
const ext = src.match(/\.(jpe?g|png)$/i)?.[0] || '';
const base = ext ? src.slice(0, -ext.length) : src;

// Build srcset strings for responsive images
// The last (largest) width uses the original file name, smaller widths use -${w}w suffix
function buildSrcset(baseStr: string, extension: string, widthList?: number[]) {
  if (!widthList || widthList.length === 0) return `${baseStr}.${extension}`;
  const sorted = [...widthList].sort((a, b) => a - b);
  return sorted.map((w, i) => {
    const path = i < sorted.length - 1 ? `${baseStr}-${w}w.${extension}` : `${baseStr}.${extension}`;
    return `${path} ${w}w`;
  }).join(', ');
}

const avifSrcset = buildSrcset(base, 'avif', widths);
const webpSrcset = buildSrcset(base, 'webp', widths);
---
<picture>
  <source srcset={avifSrcset} sizes={sizes} type="image/avif" />
  <source srcset={webpSrcset} sizes={sizes} type="image/webp" />
  <img
    src={src}
    alt={alt}
    class={className}
    width={width}
    height={height}
    loading={loading}
    decoding={loading === 'eager' ? 'sync' : 'async'}
    fetchpriority={fetchpriority}
    style={style}
  />
</picture>
